---
title: "Map visualization"
author: "dondon"
date: '2021-01-15'
slug: map-visualization
categories: R
tags: visualization
---

# 따릉이 데이터를 이용한 간단한 지도 그리기

```{r, message=F, warning=F}
library(rgdal)
library(rgeos)
library(tmap)
library(leaflet)
library(sp)
library(data.table)
library(tidyverse)
```



# 데이터 불러오기 

서울시 공공 자전거 대여소 정보는 https://data.seoul.go.kr/dataList/OA-13252/F/1/datasetView.do 에서 다운로드가 가능하다.
참고 : stn 데이터는 링크에 있는 데이터와 다른 데이터지만 정비소 좌표만 이용하기 때문에 코드의 내용은 같다. 

## 따릉이 정비소 데이터 불러오기 

```{r}
stn <- fread('C:\\Users\\uos\\Desktop\\Master\\bike sharing\\stn_info.csv', encoding = 'UTF-8')

stn <- stn %>% filter(!STATION_LONGITUDE == 0) # 좌표가 0인 정거장 제외 
stn <- stn %>% filter(!STATION_GRP_NAME == '정비센터') # 정비센터 9개 정거장 제외 
```


```{r}
stn <- stn[, c(1, 12, 8, 9)]
stn
```


## 서울특별시 시군구 데이터 불러오기 

대한민구 행정구역 관련된 데이터는 http://www.gisdeveloper.co.kr/?p=2332 에서 다운로드가 가능하다. 
```{r}
areas <- readOGR('C:\\Users\\uos\\Desktop\\Master\\Spatial Data Analysis\\서울시군구\\TL_SCCO_SIG_W.shp', encoding = 'utf-8')
coordinates(areas)
plot(areas)
```

R에서 shp 파일을 불러오기 위해서는 rgdal 패키지에 있는 readOGR 함수를 이용해야한다. 
shp 파일은 polygon 형태로 저장되어 있는 데이터인데 데이터 프레임 형태처럼 직관적이지 않기 때문에 다루기가 까다롭다. 
R에서는 shp 파일을 다루기 위해서 대표적으로 sp, sf 패키지가 있다. 
sf 패키지는 tidyvese와 연동이 잘되고 shp 파일을 데이터 프레임 형태로 직관적으로 볼 수 있다는 장점이 있다. 좌표변환이 sp 패키지보다 까다롭다. 
sp 패키지는 좌표 변환이 상대적으로 쉽고, tmap 패키지를 이용하면 ggplot만큼 쉽게 시각화가 가능하다. 

coordinates 함수를 이용해서 좌표를 볼 수 있다. 


# 좌표 변환 
좌표계 관련된 자세한 설명은 이 블로그의 글을 참고하면 된다. \
https://statkclee.github.io/spatial/geo-spatial-r.html


어떤 위치를 정의할 때 지도 api별로 다른 좌표계를 사용한다. 따라서 자료를 병합할 때에는 좌표계를 똑같이 맞춰야한다. 
서울시 행정지도의 좌표계를 보면 CRS arguments: +proj=longlat +datum=WGS84 +no_defs 이므로 따릉이 데이터의 좌표계를 EPSG:4326로 설정해주었다. \
지도 시각화를 위해서는 **sp**패키지를 이용해서 csv 파일을 SpatialPointsDataFrame으로 바꿔주여야한다. 
SpatialPointsDataFrame(**data[경도, 위도]**, data, 좌표계)이다. 
areas@bbox %>% head() : 최소, 최대 위경도를 알 수 있다. 
stn.points@coords %>% head() : 좌표값이 서울시 행정지도의 좌표값이 유사하게 바뀌었음을 알 수 있다. 

```{r}
stn.points <- SpatialPointsDataFrame(stn[,c(4,3)], stn, proj4string = CRS("+init=EPSG:4326"))
areas@proj4string
areas@bbox %>% head()
stn.points@coords %>% head()
```

# 시각화 
시각화는 shp 파일의 좌표계 변환만 잘해주면 tmap 패키지를 이용해서 간단하게 구현이 가능하다. 

* tm_shape() : 지도 불러오기 
* tm_borders(alpha = 0.5) : 점을 찍을 base line map을 생성. alpha = 경계의 선명도
* tm_compass() : 방위각 표시

변수의 범주를 어떻게 나눌지를 정하는 것이 시각화할 때 중요하다. 
옵션은 다음과 같다. 

* style = 'equal' : 변수의 range를 n으로 나눔
* style = 'pretty' : 변수의 range를 균등한 값으로 나눔
* style = 'quantile' : 각 그룹에 동일한 case 개수 할당 
* style = 'jenks' : 데이터에서 nature breaks 를 찾음 
* style = 'Cat' : 변수가  범주형 변수일 경우 


* scale : 점 크기 지정 
* n = 5(default) : interval 수 지정 
* tm_compass() : 방위각 표시 
* frame : 지도 외각에 박스 그릴지 여부 

```{r}
tm_shape(areas) + tm_borders(alpha = 0.5)+
  tm_shape(stn.points)+tm_dots(col = '거치대개수', palette = "Reds", style = "quantile", scale = 2.5) + 
  tm_compass()+
  tm_layout(legend.text.size = 0.8, legend.title.size = 1.1, frame = FALSE)
```


# interactive map 
tmap 패키지는 leaflet 패키지를 이용해서 간단하게 interactive한 map을 만들 수 있다.

```{r}
library(leaflet)
tmap_mode("view")
tm_shape(areas) + tm_borders(alpha = 0.5)+
  tm_shape(stn.points)+tm_dots(col = '거치대개수', palette = "Reds", style = "quantile", scale = 2.5) + 
  tm_compass()+
  tm_layout(legend.text.size = 0.8, legend.title.size = 1.1, frame = FALSE)
```



참고 : chrome-extension://ohfgljdgelakfkefopgklcohadegdpjf/https://spatialanalysisonline.com/An%20Introduction%20to%20Spatial%20Data%20Analysis%20in%20R.pdf